# 사장님 결제 취소 기능 명세서

## 📋 개요

### 배경

- **삼성E&A 주요 제휴점(포세카)** 및 기타 제휴점들의 지속적인 요청사항
- 기존 [PROD-14744](https://vendysdev.atlassian.net/browse/PROD-14744) 기능을 **전체 제휴점으로 확장**
- [Slack 논의 참고](https://vendys.slack.com/archives/C08P3MEPM/p1749012830342469)

### 목표

- **식권대장 사장님 웹/앱 동시 적용**
- **VONE과 동일한 환불 정책 적용**: "환불가능여부" 및 "환불불가사유" 안내
- **취소 후 양방향 푸시 알림**: 결제자(uid) 및 취소한 사장님(Said)에게 알림 발송

### 기대 효과

- **대형고객사 요구사항 대응**: 삼성E&A 포세카 등 Rock-in 효과 기대
- **CS 업무 감소**: 모든 제휴점에서 직접 취소 처리 가능
- **제휴점 서비스 향상**: 실시간 결제 취소 기능 제공

---

## 🎯 요구사항 분석

### 필수 개발 요청사항

| 구분          | 요구사항                                          |  수용여부   |
| :------------ | :------------------------------------------------ | :---------: |
| **전액 취소** | 식권대장 사장님은 전액취소만 가능 (부분취소 불가) |   ✅ 수용   |
| **월말 제한** | 월말일자 24시 이후 결제 취소 시 1:1문의 팝업 안내 |   ✅ 수용   |
| **푸시 기능** | 포인트 유효기간에 따른 차별화된 푸시 메시지       |   ✅ 수용   |
| **이중 확인** | 결제 취소 시 실수 방지용 재알림 확인              |   ✅ 수용   |
| **양자 확인** | 사용자-사장님 간 양방향 취소 승인 프로세스        | ❌ 수용불가 |

### 수용불가 사유

**양자확인 기능**: 기술적 복잡성 및 개발 기간 제약으로 1차 제외

- 예상 시나리오: [사장님]취소요청 → [서버]취소확인요청 → [식권대장app]취소승인 → [서버]취소완료

---

## 🖥️ 프론트엔드 개발 범위

### 식권대장 사장님 (웹/앱)

#### 페이지 경로

```
[식권대장사장님] 실시간 매출 페이지 > 상세내역
```

#### 1. [결제취소] 버튼 노출 조건

##### 권한 조건

- **사용자 권한 조회를 통해** `OWNER` 등급만 버튼 노출
- **현황**: OWNER(18,271개) / MANAGER(314개) / STAFF(114개)
- **계정 상태**: 정상 활성화된 계정 및 매장만 대상

##### 결제 상태 조건

- **결제 내역 조회를 통해** 결제완료 상태이면서 금액이 0원 초과인 경우만 노출

#### 2. [결제취소] 버튼 클릭 이벤트

##### 취소 가능 여부 분기

**결제 내역 조회를 통해** 취소 가능 여부를 판단하여 적절한 팝업을 호출합니다.

- **취소 가능한 경우**: 사장님 결제 취소 딤팝업 호출
- **취소 불가한 경우**: 결제 취소 불가 딤팝업 호출

#### 3. 사장님 결제 취소 딤팝업

##### 환불 정보 표시

**쿠폰 상세 정보 및 결제 내역 조회를 통해** 환불 관련 정보를 표시합니다.

- **환불 가능한 경우**: 별도 안내문구 미노출
- **환불 불가한 경우**: "환불불가 포인트가 존재합니다." 안내문구 노출
- **환불 불가 사유**: 유효기간 만료, 사용완료 등의 사유와 해당 금액을 함께 표시

##### 취소 사유 선택

```
📋 취소사유 (필수 선택)
□ 착오결제(타매장 이용)로 결제취소
□ 금액/결제수단 변경으로 결제취소
□ 취소 사유 직접입력
   └ [입력필드: 취소사유를 입력해주세요(30자 이하)]
```

##### [결제취소] 버튼 활성화 조건

- [x] **필수**: 유의사항 확인 및 결제 취소에 동의합니다.
- [x] **필수**: 취소사유 선택 (직접입력 시 30자 이하 입력 완료)

#### 4. 취소 요청 및 응답 처리

##### 취소 요청

**결제 취소 API 호출을 통해** 선택된 취소사유와 함께 취소 요청을 전송합니다.

- **취소 성공 시**: 결제 취소 완료 딤팝업 표시
- **취소 실패 시**: 결제 취소 실패 딤팝업 표시

##### 완료 후 처리

**팝업 닫기 시** 결제 내역 목록을 새로고침하여 최신 상태를 반영합니다.

---

## 🔧 백엔드 개발 범위

### 백엔드 로직 수정 및 추가

#### 1. 결제 내역 조회 기능 확장

##### 추가 정보 제공

**기존 결제 내역 조회에** 다음 정보들을 추가로 제공합니다:

- **포인트 환불가능 여부**: 환불 가능한 포인트인지 판단
- **환불불가 사유**: 유효기간 만료, 사용완료 등의 구체적 사유
- **환불불가 금액**: 환불할 수 없는 포인트 금액
- **취소 가능 여부**: 해당 결제건의 취소 가능성 판단

##### 취소 가능 여부 판정 로직

**취소 가능 조건**:

- 취소 요청 월과 결제 월이 동일한 경우
- 지원되는 매장 유형 (일반매장, 구내식당 등)
- 구내식당의 경우 캡틴코드 보유 매장

**취소 불가 조건**:

- 전월/과월 결제건
- 외부POS 연동 매장
- 지원되지 않는 매장 유형

#### 2. 결제 취소 처리 기능 추가

##### 취소 요청 처리

**새로운 결제 취소 기능**을 통해 다음 정보를 받아 처리합니다:

- **취소사유**: 선택된 사유 또는 직접입력 내용을 저장

##### 데이터베이스 상태 업데이트

**결제 취소 시** 다음과 같이 데이터를 업데이트합니다:

- 결제그룹 상태를 '제휴점 전체 취소'로 변경
- 취소사유를 해당 필드에 저장
- 관련 상태코드를 시스템에 정의

### 푸시 알림 시스템

#### 1. 결제자 푸시

**환불 가능 여부에 따라** 차별화된 푸시 메시지를 발송합니다:

- **환불 가능한 경우**: "{매장명}에서 결제를 취소했습니다."
- **환불 불가한 경우**: "{매장명}에서 결제를 취소했습니다.(식대가 소멸되었습니다.)"

#### 2. 제휴점 푸시

**취소를 진행한 사장님 또는 매장 관리자**에게 푸시 알림을 발송합니다:

- **환불 가능한 경우**: "{사용자명}의 결제를 취소했습니다."
- **환불 불가한 경우**: "{사용자명}의 결제를 취소했습니다.(식대가 소멸되었습니다.)"
- **개인정보 보호**: 사용자명은 기존 결제완료 푸시와 동일하게 가운데 마스킹 처리

#### 3. 푸시 클릭 이벤트

**식권대장 앱에서 푸시 알림 클릭 시** 기존 취소내역 페이지로 이동합니다.

---

## 🎨 UI/UX 설계

### 딤팝업 화면 구성

#### 1. 결제취소 딤팝업 (환불가능)

```
┌─────────────────────────────────┐
│        결제 취소                  │
├─────────────────────────────────┤
│ 💰 결제금액: 15,000원              │
│ ✅ 전액 환불 가능                  │
│                                 │
│ 📋 취소사유 (필수)                │
│ □ 착오결제(타매장 이용)로 결제취소    │
│ □ 금액/결제수단 변경으로 결제취소     │
│ ☑ 취소 사유 직접입력               │
│ [고객 요청으로 인한 취소_______]      │
│                                 │
│ ☑ 유의사항 확인 및 결제 취소에 동의  │
│                                 │
│ [닫기]              [결제취소]     │
└─────────────────────────────────┘
```

#### 2. 결제취소 딤팝업 (환불불가)

```
┌─────────────────────────────────┐
│        결제 취소                  │
├─────────────────────────────────┤
│ 💰 결제금액: 15,000원              │
│ ⚠️ 환불불가 포인트가 존재합니다.      │
│                                 │
│ 🔍 포인트 환불 불가 사유            │
│    유효기간 만료 (7,000 포인트)     │
│                                 │
│ 📋 취소사유 (필수)                │
│ ☑ 착오결제(타매장 이용)로 결제취소    │
│                                 │
│ ☑ 유의사항 확인 및 결제 취소에 동의  │
│                                 │
│ [닫기]              [결제취소]     │
└─────────────────────────────────┘
```

#### 3. 결제취소 불가 딤팝업

```
┌─────────────────────────────────┐
│        결제 취소 불가              │
├─────────────────────────────────┤
│ ❌ 해당 결제건은 취소할 수 없습니다.   │
│                                 │
│ 📞 월말일자 24시 이후 결제건 또는    │
│    외부POS 결제건은 1:1문의를       │
│    이용해주세요.                   │
│                                 │
│              [1:1문의하기]          │
│              [닫기]               │
└─────────────────────────────────┘
```

---

## 📊 테스트 시나리오

### 기능 테스트

#### 1. 권한 및 노출 테스트

- [ ] OWNER 등급만 [결제취소] 버튼 노출
- [ ] MANAGER/STAFF 등급은 버튼 미노출
- [ ] 결제완료 상태 & 금액 > 0 조건 확인

#### 2. 취소 가능/불가 분기 테스트

- [ ] 동일 월 결제건: 취소 가능 팝업
- [ ] 전월/과월 결제건: 취소 불가 팝업
- [ ] 외부POS: 취소 불가 팝업
- [ ] 구내식당 캡틴코드: 취소 가능 확인

#### 3. 환불 정보 표시 테스트

- [ ] 환불가능 시: 안내문구 미노출
- [ ] 환불불가 시: "환불불가 포인트 존재" 표시
- [ ] 환불불가 사유 & 금액 정확 표시

#### 4. 취소사유 입력 테스트

- [ ] 기본 사유 선택 시 정상 전송
- [ ] 직접입력 시 30자 제한 확인
- [ ] 필수 체크박스 미선택 시 버튼 비활성화

#### 5. 푸시 알림 테스트

- [ ] 결제자 푸시: 환불가능/불가 메시지 분기
- [ ] 사장님 푸시: 취소자에게 발송
- [ ] 푸시 클릭 시 취소내역 페이지 이동

### 통합 테스트

- [ ] 웹/앱 동시 동작 확인
- [ ] VONE 환불정책과 일치성 검증
- [ ] 대용량 트래픽 상황 안정성 테스트
